"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.hasStack = exports.getStack = exports.deployStackAsync = exports.deployStack = exports.deleteStack = void 0;
var _clientCloudformation = require("@aws-sdk/client-cloudformation");
var Time = _interopRequireWildcard(require("@dashkite/joy/time"));
var _helpers = require("./helpers.js");
var _jsYaml = _interopRequireDefault(require("js-yaml"));
var Type = _interopRequireWildcard(require("@dashkite/joy/type"));
function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }
function _getRequireWildcardCache(nodeInterop) { if (typeof WeakMap !== "function") return null; var cacheBabelInterop = new WeakMap(); var cacheNodeInterop = new WeakMap(); return (_getRequireWildcardCache = function (nodeInterop) { return nodeInterop ? cacheNodeInterop : cacheBabelInterop; })(nodeInterop); }
function _interopRequireWildcard(obj, nodeInterop) { if (!nodeInterop && obj && obj.__esModule) { return obj; } if (obj === null || typeof obj !== "object" && typeof obj !== "function") { return { default: obj }; } var cache = _getRequireWildcardCache(nodeInterop); if (cache && cache.has(obj)) { return cache.get(obj); } var newObj = {}; var hasPropertyDescriptor = Object.defineProperty && Object.getOwnPropertyDescriptor; for (var key in obj) { if (key !== "default" && Object.prototype.hasOwnProperty.call(obj, key)) { var desc = hasPropertyDescriptor ? Object.getOwnPropertyDescriptor(obj, key) : null; if (desc && (desc.get || desc.set)) { Object.defineProperty(newObj, key, desc); } else { newObj[key] = obj[key]; } } } newObj.default = obj; if (cache) { cache.set(obj, newObj); } return newObj; }
var AWS, deleteStack, deployStack, deployStackAsync, getStack, getStatus, hasStack, nodes;
exports.hasStack = hasStack;
exports.getStack = getStack;
exports.deployStackAsync = deployStackAsync;
exports.deployStack = deployStack;
exports.deleteStack = deleteStack;
AWS = {
  CloudFormation: new _clientCloudformation.CloudFormation({
    region: "us-east-1"
  })
};
exports.hasStack = hasStack = async function (name) {
  return (await getStack(name)) != null;
};
exports.getStack = getStack = async function (name) {
  var Stacks, ref;
  try {
    ({
      Stacks
    } = await AWS.CloudFormation.describeStacks({
      StackName: name
    }));
    return {
      // TODO is there anything else to return here?
      status: (ref = Stacks[0]) != null ? ref.StackStatus : void 0,
      _: Stacks[0]
    };
  } catch (error1) {
    return void 0;
  }
};
getStatus = async function (context) {
  var ref, ref1;
  context.stack = await getStack(context.name);
  return (ref = (ref1 = context.stack) != null ? ref1.status : void 0) != null ? ref : "create";
};
nodes = [{
  pattern: "start",
  next: getStatus,
  nodes: [{
    pattern: /UPDATE_ROLLBACK_(COMPLETE|FAILED)$/,
    next: function () {
      return "update";
    }
  }, {
    pattern: /ROLLBACK_(COMPLETE|FAILED)$/,
    next: function () {
      return "delete";
    }
  }, {
    pattern: /COMPLETE$/,
    next: function () {
      return "update";
    }
  }]
}, {
  pattern: "create",
  action: function ({
    template
  }) {
    return AWS.CloudFormation.createStack(template);
  },
  next: getStatus
}, {
  pattern: "update",
  action: function ({
    template
  }) {
    return AWS.CloudFormation.updateStack(template);
  },
  next: getStatus
}, {
  pattern: "delete",
  action: function ({
    name
  }) {
    return AWS.CloudFormation.deleteStack({
      StackName: name
    });
  },
  next: getStatus
}, {
  pattern: "done",
  result: function ({
    stack
  }) {
    return stack;
  }
}, {
  pattern: /^(CREATE|UPDATE)_COMPLETE$/,
  next: function () {
    return "done";
  }
}, {
  pattern: "DELETE_COMPLETE",
  next: function () {
    return "create";
  }
}, {
  pattern: /ROLLBACK_(COMPLETE|FAILED)$/,
  next: function ({
    name
  }) {
    throw new Error(`Deploy failed for [ ${name} ]`);
  }
}, {
  pattern: /IN_PROGRESS$/,
  action: function () {
    return Time.sleep(5000);
  },
  next: getStatus
}, {
  pattern: /FAILED$/,
  result: function ({
    name
  }) {
    throw new Error(`Unable to gracefully recover from state [ ${name} ]`);
  }
}];
exports.deployStack = deployStack = async function (name, template, capabilities) {
  var context, error, state;
  if (capabilities == null) {
    capabilities = ["CAPABILITY_IAM"];
  }
  if (Type.isObject(template)) {
    template = _jsYaml.default.dump(template);
  }
  console.log(template);
  state = {
    name: "start"
  };
  context = {
    name: name,
    template: {
      StackName: name,
      Capabilities: capabilities,
      // Tags: [{
      //   Key: "domain"
      //   Value: configuration.tld
      // }]
      TemplateBody: template
    }
  };
  try {
    return await (0, _helpers.runNetwork)(nodes, state, context);
  } catch (error1) {
    error = error1;
    if (/No updates/.test(error.toString())) {
      return console.log(`no updates for stack [${name}]`);
    } else {
      throw error;
    }
  }
};
exports.deployStackAsync = deployStackAsync = async function (name, _template, capabilities) {
  var template;
  console.log(_template);
  template = {
    StackName: name,
    Capabilities: capabilities != null ? capabilities : ["CAPABILITY_IAM"],
    TemplateBody: _template
  };
  if (await hasStack(name)) {
    return AWS.CloudFormation.updateStack(template);
  } else {
    return AWS.CloudFormation.createStack(template);
  }
};
exports.deleteStack = deleteStack = function (name) {
  return AWS.CloudFormation.deleteStack({
    StackName: name
  });
};
//# sourceMappingURL=data:application/json;base64,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QUQ3QjtJQUVBLFlBQUEsRUFBYztFQUZkLENBQUE7RUFJRixJQUFHLE1BQU0sUUFBQSxDQUFTLElBQVQsQ0FBVCxFQUFBO1dBQ0UsR0FBRyxDQUFDLGNBQWMsQ0FBQyxXQUFuQixDQUErQixRQUEvQixDQURGO0dBQUEsTUFBQTtXQUdFLEdBQUcsQ0FBQyxjQUFjLENBQUMsV0FBbkIsQ0FBK0IsUUFBL0IsQ0FIRjs7QUFSaUIsQ0FBQTtBQWNuQixPQUFBLENBQUEsV0FBQSxHQUFBLFdBQUEsR0FBYyxTQUFBLENBQUMsSUFBRCxFQUFBO1NBQ1osR0FBRyxDQUFDLGNBQWMsQ0FBQyxXQUFuQixDQUErQjtJQUFBLFNBQUEsRUFBVztFQUFYLENBQS9CLENBQUE7QUFEWSxDQUFBIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQ2xvdWRGb3JtYXRpb24gfSBmcm9tIFwiQGF3cy1zZGsvY2xpZW50LWNsb3VkZm9ybWF0aW9uXCJcbmltcG9ydCAqIGFzIFRpbWUgZnJvbSBcIkBkYXNoa2l0ZS9qb3kvdGltZVwiXG5pbXBvcnQgeyBydW5OZXR3b3JrIH0gZnJvbSBcIi4vaGVscGVyc1wiXG5pbXBvcnQgWUFNTCBmcm9tIFwianMteWFtbFwiXG5pbXBvcnQgKiBhcyBUeXBlIGZyb20gXCJAZGFzaGtpdGUvam95L3R5cGVcIlxuXG5BV1MgPVxuICBDbG91ZEZvcm1hdGlvbjogbmV3IENsb3VkRm9ybWF0aW9uIHJlZ2lvbjogXCJ1cy1lYXN0LTFcIlxuXG5oYXNTdGFjayA9IChuYW1lKSAtPiAoYXdhaXQgZ2V0U3RhY2sgbmFtZSk/XG5cbmdldFN0YWNrID0gKG5hbWUpIC0+XG4gIHRyeVxuICAgIHsgU3RhY2tzIH0gPSBhd2FpdCBBV1MuQ2xvdWRGb3JtYXRpb24uZGVzY3JpYmVTdGFja3MgU3RhY2tOYW1lOiBuYW1lXG4gICAgIyBUT0RPIGlzIHRoZXJlIGFueXRoaW5nIGVsc2UgdG8gcmV0dXJuIGhlcmU/XG4gICAgc3RhdHVzOiBTdGFja3NbMF0/LlN0YWNrU3RhdHVzXG4gICAgXzogU3RhY2tzWzBdXG4gIGNhdGNoXG4gICAgdW5kZWZpbmVkXG5cbmdldFN0YXR1cyA9IChjb250ZXh0KSAtPlxuICBjb250ZXh0LnN0YWNrID0gYXdhaXQgZ2V0U3RhY2sgY29udGV4dC5uYW1lXG4gIGNvbnRleHQuc3RhY2s/LnN0YXR1cyA/IFwiY3JlYXRlXCJcblxubm9kZXMgPSBbXG5cbiAgICBwYXR0ZXJuOiBcInN0YXJ0XCJcbiAgICBuZXh0OiBnZXRTdGF0dXNcbiAgICBub2RlczogW1xuICAgICAgICBwYXR0ZXJuOiAvVVBEQVRFX1JPTExCQUNLXyhDT01QTEVURXxGQUlMRUQpJC9cbiAgICAgICAgbmV4dDogLT4gXCJ1cGRhdGVcIlxuICAgICAgLFxuICAgICAgICBwYXR0ZXJuOiAvUk9MTEJBQ0tfKENPTVBMRVRFfEZBSUxFRCkkL1xuICAgICAgICBuZXh0OiAtPiBcImRlbGV0ZVwiXG4gICAgICAsXG4gICAgICAgIHBhdHRlcm46IC9DT01QTEVURSQvXG4gICAgICAgIG5leHQ6IC0+IFwidXBkYXRlXCJcbiAgICBdXG4gICxcbiAgICBwYXR0ZXJuOiBcImNyZWF0ZVwiXG4gICAgYWN0aW9uOiAoeyB0ZW1wbGF0ZSB9KSAtPiBBV1MuQ2xvdWRGb3JtYXRpb24uY3JlYXRlU3RhY2sgdGVtcGxhdGVcbiAgICBuZXh0OiBnZXRTdGF0dXNcbiAgLFxuICAgIHBhdHRlcm46IFwidXBkYXRlXCJcbiAgICBhY3Rpb246ICh7IHRlbXBsYXRlIH0pIC0+IEFXUy5DbG91ZEZvcm1hdGlvbi51cGRhdGVTdGFjayB0ZW1wbGF0ZVxuICAgIG5leHQ6IGdldFN0YXR1c1xuICAsXG4gICAgcGF0dGVybjogXCJkZWxldGVcIlxuICAgIGFjdGlvbjogKHsgbmFtZSB9KSAtPiBBV1MuQ2xvdWRGb3JtYXRpb24uZGVsZXRlU3RhY2sgU3RhY2tOYW1lOiBuYW1lXG4gICAgbmV4dDogZ2V0U3RhdHVzXG4gICxcbiAgICBwYXR0ZXJuOiBcImRvbmVcIlxuICAgIHJlc3VsdDogKHsgc3RhY2sgfSkgLT4gc3RhY2sgXG4gICxcbiAgICBwYXR0ZXJuOiAvXihDUkVBVEV8VVBEQVRFKV9DT01QTEVURSQvXG4gICAgbmV4dDogLT4gXCJkb25lXCJcbiAgLFxuICAgIHBhdHRlcm46IFwiREVMRVRFX0NPTVBMRVRFXCJcbiAgICBuZXh0OiAtPiBcImNyZWF0ZVwiXG4gICxcbiAgICBwYXR0ZXJuOiAvUk9MTEJBQ0tfKENPTVBMRVRFfEZBSUxFRCkkL1xuICAgIG5leHQ6ICh7bmFtZX0pIC0+IHRocm93IG5ldyBFcnJvciBcIkRlcGxveSBmYWlsZWQgZm9yIFsgI3tuYW1lfSBdXCJcbiAgLFxuICAgIHBhdHRlcm46IC9JTl9QUk9HUkVTUyQvXG4gICAgYWN0aW9uOiAtPiBUaW1lLnNsZWVwIDUwMDBcbiAgICBuZXh0OiBnZXRTdGF0dXNcbiAgLFxuICAgIHBhdHRlcm46IC9GQUlMRUQkL1xuICAgIHJlc3VsdDogKHtuYW1lfSkgLT4gdGhyb3cgbmV3IEVycm9yIFwiVW5hYmxlIHRvIGdyYWNlZnVsbHkgcmVjb3ZlciBmcm9tIHN0YXRlIFsgI3tuYW1lfSBdXCJcblxuXVxuXG5kZXBsb3lTdGFjayA9IChuYW1lLCB0ZW1wbGF0ZSwgY2FwYWJpbGl0aWVzKSAtPlxuXG4gIGNhcGFiaWxpdGllcyA/PSBbIFwiQ0FQQUJJTElUWV9JQU1cIiBdXG5cbiAgaWYgVHlwZS5pc09iamVjdCB0ZW1wbGF0ZVxuICAgIHRlbXBsYXRlID0gWUFNTC5kdW1wIHRlbXBsYXRlXG5cbiAgY29uc29sZS5sb2cgdGVtcGxhdGVcblxuICBzdGF0ZSA9IG5hbWU6IFwic3RhcnRcIlxuXG4gIGNvbnRleHQgPVxuICAgIG5hbWU6IG5hbWVcbiAgICB0ZW1wbGF0ZTogXG4gICAgICBTdGFja05hbWU6IG5hbWVcbiAgICAgIENhcGFiaWxpdGllczogY2FwYWJpbGl0aWVzXG4gICAgICAjIFRhZ3M6IFt7XG4gICAgICAjICAgS2V5OiBcImRvbWFpblwiXG4gICAgICAjICAgVmFsdWU6IGNvbmZpZ3VyYXRpb24udGxkXG4gICAgICAjIH1dXG4gICAgICBUZW1wbGF0ZUJvZHk6IHRlbXBsYXRlXG5cbiAgdHJ5XG4gICAgYXdhaXQgcnVuTmV0d29yayBub2Rlcywgc3RhdGUsIGNvbnRleHRcbiAgY2F0Y2ggZXJyb3JcbiAgICBpZiAvTm8gdXBkYXRlcy8udGVzdCBlcnJvci50b1N0cmluZygpXG4gICAgICBjb25zb2xlLmxvZyBcIm5vIHVwZGF0ZXMgZm9yIHN0YWNrIFsje25hbWV9XVwiXG4gICAgZWxzZVxuICAgICAgdGhyb3cgZXJyb3JcblxuZGVwbG95U3RhY2tBc3luYyA9IChuYW1lLCBfdGVtcGxhdGUsIGNhcGFiaWxpdGllcykgLT5cbiAgY29uc29sZS5sb2cgX3RlbXBsYXRlXG5cbiAgdGVtcGxhdGUgPVxuICAgIFN0YWNrTmFtZTogbmFtZVxuICAgIENhcGFiaWxpdGllczogY2FwYWJpbGl0aWVzID8gWyBcIkNBUEFCSUxJVFlfSUFNXCIgXVxuICAgIFRlbXBsYXRlQm9keTogX3RlbXBsYXRlXG5cbiAgaWYgYXdhaXQgaGFzU3RhY2sgbmFtZVxuICAgIEFXUy5DbG91ZEZvcm1hdGlvbi51cGRhdGVTdGFjayB0ZW1wbGF0ZVxuICBlbHNlXG4gICAgQVdTLkNsb3VkRm9ybWF0aW9uLmNyZWF0ZVN0YWNrIHRlbXBsYXRlXG4gICAgXG5cbmRlbGV0ZVN0YWNrID0gKG5hbWUpIC0+XG4gIEFXUy5DbG91ZEZvcm1hdGlvbi5kZWxldGVTdGFjayBTdGFja05hbWU6IG5hbWVcblxuZXhwb3J0IHtcbiAgaGFzU3RhY2tcbiAgZ2V0U3RhY2tcbiAgZGVwbG95U3RhY2tcbiAgZGVwbG95U3RhY2tBc3luY1xuICBkZWxldGVTdGFja1xufSJdLCJzb3VyY2VSb290IjoiIn0=
//# sourceURL=src/stack.coffee